#!/bin/bash

has_migrations=false

cd ~/Development/brokerengine-react/

yarn build

if [ $? -eq 0 ]
then
  echo "Successfully created file"
  git add frontend
  git commit -n -m 'build'

  cd django-root/

  # check any initial compile issues, usually broken imports etc will
  # be catched here
  python manage.py 2>&1 > /dev/null
  if [ $? -eq 1 ]; then
    echo "initial compile test failed"
    exit 1
  fi

  if ! python manage.py makemigrations --merge --noinput | { egrep 'No conflicts detected to merge' || true ; } ; then
    has_migrations=true
  fi

  if ! python manage.py makemigrations --noinput | { egrep "No changes detected" || true ; } ; then
    has_migrations=true
  fi

  if $has_migrations; then
    echo "commiting migrations $has_migrations"
    git add be_client_portal/migrations/ be_core/migrations/ be_api/migrations/
    git commit -n -m 'migrations'
  fi

  if [[ "$1" == "dev1" ]]; then
    # deploy to remote
    echo "executing git push bedev1 dev -f"
    git push bedev1 dev -f

    ssh bedev1 "/home/brokerengine/bin/deploy-build"
  fi

  say "Build successful"
else
  say "Sorry. Build failed"
fi
